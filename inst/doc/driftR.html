<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Andrew Shaughnessy, Christopher Prener, Elizabeth Hasenmueller" />

<meta name="date" content="2018-06-13" />

<title>Applying Drift Corrections with driftR</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#header {
text-align: center;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; }  code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>

</head>

<body>




<h1 class="title toc-ignore">Applying Drift Corrections with driftR</h1>
<h4 class="author"><em>Andrew Shaughnessy, Christopher Prener, Elizabeth Hasenmueller</em></h4>
<h4 class="date"><em>2018-06-13</em></h4>



<div id="overview" class="section level2">
<h2>Overview</h2>
<p>In situ water quality monitoring instruments take continuous measurements of various chemical and physical parameters. The longer these instruments stay in the field, the further sensor readings drift from their true values. The purpose of this package is to correct water quality monitoring data sets for instrumental drift in a reliable, reproducible method.</p>
</div>
<div id="getting-started-with-r" class="section level2">
<h2>Getting Started with <code>R</code></h2>
<p>If you are new to <code>R</code>, welcome! You will need to <a href="https://www.r-project.org">download <code>R</code></a>. We also recommend downloading <a href="https://www.rstudio.com/products/rstudio/download/#download">RStudio</a>. Once you have those installed, you can install <code>driftR</code>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">install.packages</span>(<span class="st">&quot;driftR&quot;</span>)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw">library</span>(driftR)</a></code></pre></div>
<p>If you want, install the <code>devtools</code> package to install the development version of <code>driftR</code>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">install.packages</span>(<span class="st">&quot;devtools&quot;</span>)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">devtools<span class="op">::</span><span class="kw">install_github</span>(<span class="st">&quot;shaughnessyar/driftR&quot;</span>)</a></code></pre></div>
<p>macOS users should also <a href="https://www.xquartz.org">download and install XQuartz</a>.</p>
</div>
<div id="packages" class="section level2">
<h2>Packages</h2>
<p>In addition to <code>driftR</code>, you will also want to install and load at least two other packages:</p>
<ul>
<li><a href="http://dplyr.tidyverse.org"><code>dplyr</code></a> - a set of common verbs for cleaning and wrangling data</li>
<li><a href="http://readr.tidyverse.org"><code>readr</code></a> - tools for reading and writing plain-text data files</li>
</ul>
<p>Both of these packages can be installed with the <code>install.packages()</code> function. Since both are part of the <a href="http://tidyverse.org"><code>tidyverse</code></a>, you can also install both at once by using <code>install.packages(&quot;tidyverse&quot;)</code>.</p>
</div>
<div id="equations" class="section level2">
<h2>Equations</h2>
<p>The drift correction equations that are implemented in <code>driftR</code> were originally published as part of <a href="https://www.slu.edu/arts-and-sciences/earth-atmospheric-sciences/faculty/hasenmueller-elizabeth.php">Dr. Elizabeth Hasenmueller’s</a> <a href="http://openscholarship.wustl.edu/cgi/viewcontent.cgi?article=1584&amp;amp=&amp;context=etd&amp;amp=&amp;sei-redir=1&amp;referer=https%253A%252F%252Fscholar.google.com%252Fscholar%253Fhl%253Den%2526as_sdt%253D0%25252C26%2526q%253Dhasenmueller%252Bwash%252Bu%2526btnG%253D#search=%22hasenmueller%20wash%20u%22">dissertation research</a> (see page 32).</p>
<div id="correction-factor" class="section level3">
<h3>Correction Factor</h3>
<p>The correction factor equation (implemented in <code>dr_factor()</code>) is as follows:</p>
<p><span class="math inline">\(\textrm{Let:}\)</span></p>
<ul>
<li><span class="math inline">\({f}_{t} = \textrm{correction factor}\)</span></li>
<li><span class="math inline">\(t = \textrm{time interval}\)</span></li>
<li><span class="math inline">\(\sum{t} = \textrm{total time}\)</span></li>
</ul>
<p><span class="math display">\[ {f}_{t} = \left( \frac { t }{ \sum { t }  }  \right) \]</span></p>
</div>
<div id="one-point-calibration" class="section level3">
<h3>One-Point Calibration</h3>
<p>The one-point calibration equation (implemented in <code>dr_correctOne()</code>) is as follows:</p>
<p><span class="math inline">\(\textrm{Let:}\)</span></p>
<ul>
<li><span class="math inline">\(C = \textrm{drift corrected parameter}\)</span></li>
<li><span class="math inline">\(m = \textrm{uncorrected in-situ measurement parameter}\)</span></li>
<li><span class="math inline">\({f}_{t} = \textrm{correction factor}\)</span></li>
<li><span class="math inline">\({s}_{i} = \textrm{calibration standard value}\)</span></li>
<li><span class="math inline">\({s}_{f} = \textrm{calibration standard value after drift has occurred}\)</span></li>
</ul>
<p><span class="math display">\[ C =  m + {f}_{t} \cdot \left( { s }_{ i }-{ s }_{ f } \right) \]</span></p>
</div>
<div id="two-point-calibration" class="section level3">
<h3>Two-Point Calibration</h3>
<p>The two-point calibration equation (implemented in <code>dr_correctTwo()</code>) is as follows:</p>
<p><span class="math inline">\(\textrm{Let:}\)</span></p>
<ul>
<li><span class="math inline">\(C = \textrm{drift corrected parameter}\)</span></li>
<li><span class="math inline">\(m = \textrm{uncorrected in-situ measurement parameter}\)</span></li>
<li><span class="math inline">\({f}_{t} = \textrm{correction factor}\)</span></li>
<li><span class="math inline">\({a}_{t} = \textrm{drift correction using lower concentration calibration standard}\)</span></li>
<li><span class="math inline">\({b}_{t} = \textrm{drift correction using higher concentration calibration standard}\)</span></li>
<li><span class="math inline">\({a}_{i} = \textrm{lower calibration standard value}\)</span></li>
<li><span class="math inline">\({b}_{i} = \textrm{higher calibration standard value}\)</span></li>
<li><span class="math inline">\({a}_{f} = \textrm{lower calibration standard value after drift has occurred}\)</span></li>
<li><span class="math inline">\({b}_{f} = \textrm{higher calibration standard value after drift has occurred}\)</span></li>
</ul>
<p><span class="math display">\[ { a }_{ t } = { a }_{ i } + {f}_{t} \cdot \left( { a }_{ i }-{ a }_{ f } \right) \]</span> <span class="math display">\[ { b }_{ t } = { b }_{ i } - {f}_{t} \cdot \left( { b }_{ i }-{ b }_{ f } \right) \]</span> <span class="math display">\[ C=\left( \frac { m-a_{ t } }{ { b }_{ t }-{ a }_{ t }  }  \right) \cdot \left( { b }_{ i }-{ a }_{ i } \right) + { a }_{ i } \]</span></p>
</div>
</div>
<div id="using-driftr" class="section level2">
<h2>Using <code>driftR</code></h2>
<p>There are six main functions in the <code>driftR</code> which each serve their own purpose in data cleaning process:</p>
<ol style="list-style-type: decimal">
<li><code>dr_read()</code> - import water quality data</li>
<li><code>dr_factor()</code> - apply correction factors</li>
<li><code>dr_correctOne()</code> - one point calibration</li>
<li><code>dr_correctTwo()</code> - two point calibration</li>
<li><code>dr_drop()</code> - drop observations 1) at the start and finish of a data set, 2) over a specific date range, or 3) expressionally.</li>
<li><code>dr_replace()</code> - replace observations with NA 1) for specific date ranges or 2) expressionally.</li>
</ol>
<div id="importing-data" class="section level3">
<h3>Importing Data</h3>
<p>To import a data set, the <code>dr_read()</code> function is utilized. The argument <code>file</code> tells the function where the data is located.The argument <code>instrument</code> tells the function what instrument collected the data for formatting purposes. Accepted instruments are currently YSI Multiparameter V2 Sonde (<code>instrument = &quot;Sonde&quot;</code>), YSI EXO2 (<code>instrument = &quot;EXO&quot;</code>), and Onset U24 Conductivity Logger (<code>instrument = &quot;HOBO&quot;</code>). The argument <code>defineVar</code> is a logical statement where if <code>FALSE</code>, the data will be imported with no modifications, and if <code>TRUE</code>, the “units” observation will be removed and the data will be stored as numeric variables. The argument <code>cleanVar</code> is a logical statement that, if <code>TRUE</code>, will remove all special characters, numbers, and spaces from variable names in order to increase the ease of working with the data in R. For example, for the YSI Sonde 6600, turbidity is exported from the instrument as Turbidity+. This makes it hard to call the variable in R because the <code>+</code> is seen as an operation. The argument <code>case</code> is a string that tells <code>dr_read</code> how you want the clean variable names formatted. The default is “snake”, but there are lots of options to choose from. The options and their respective outputs can be found in the <code>clean_names</code> function of the <a href="https://CRAN.R-project.org/package=janitor"><code>janitor</code></a> package.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">waterTibble &lt;-<span class="st"> </span><span class="kw">dr_read</span>(<span class="dt">file =</span> <span class="st">&quot;sondeData.csv&quot;</span>, <span class="dt">instrument =</span> <span class="st">&quot;Sonde&quot;</span>, </a>
<a class="sourceLine" id="cb3-2" data-line-number="2">                       <span class="dt">defineVar =</span> <span class="ot">TRUE</span>, <span class="dt">cleanVar =</span> <span class="ot">TRUE</span>, <span class="dt">case =</span> <span class="st">&quot;snake&quot;</span>)</a></code></pre></div>
<p>If you want to use the package and do not have your own data, you can load the sample data included in the package using the following syntax:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">waterTibble &lt;-<span class="st"> </span><span class="kw">dr_read</span>(<span class="dt">file =</span> <span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;rawData.csv&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;driftR&quot;</span>),</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">                       <span class="dt">instrument =</span> <span class="st">&quot;Sonde&quot;</span>, <span class="dt">defineVar =</span> <span class="ot">TRUE</span>, <span class="dt">cleanVar=</span> <span class="ot">TRUE</span>, <span class="dt">case =</span> <span class="st">&quot;snake&quot;</span>)</a></code></pre></div>
<p><em>If your data are from another instrument model or brand, please refer to our <a href="OtherData.html">article on importing data from other sources</a>.</em></p>
</div>
<div id="creating-correction-factors" class="section level3">
<h3>Creating Correction Factors</h3>
<p>The next step in the data cleaning process is creating correction factors using <code>dr_factor()</code>. The correction factors that are generated are used to determine how much drift is experienced by each observation in the data set. The argument <code>.data</code> is the working data frame for the correction. <code>corrFactor</code> is the name of the variable that will contain the correction factors. The argument <code>dateVar</code> is the date variable for the data set and <code>timeVar</code> is the time variable. The argument <code>keepDateTime</code> is a logical term that, if TRUE, will keep an intermediate dateTime variable and export it with the correction factors.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">waterTibble &lt;-<span class="st"> </span><span class="kw">dr_factor</span>(waterTibble, <span class="dt">corrFactor =</span> corfac, <span class="dt">dateVar=</span> Date,</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">                         <span class="dt">timeVar =</span> Time, <span class="dt">keepDateTime =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
</div>
<div id="correcting-the-data" class="section level3">
<h3>Correcting the Data</h3>
<p>After creating the correction factors, you can correcting the data for drift. In order to correct the data, there needs to be some measurement taken that tells the user what the instrument should be reading compared to what the instrument is actually reading. This step can be done with either one or two standard measurements. If one standard measurement is taken, then the function <code>dr_correctOne()</code> is used. The argument <code>.data</code> is the working data frame for the correction. <code>sourceVar</code> is the variable name that you want to correct and <code>cleanVar</code> is the name of the variable that will contain the corrected data. The arguments <code>calVal</code> and <code>calStd</code> are what the instrument was reading and the standard value (i.e. what it should have been reading), respectively. The <code>factorVar</code> argument is the result generated from the <code>dr_factor()</code> function.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">waterTibble &lt;-<span class="st"> </span><span class="kw">dr_correctOne</span>(waterTibble, <span class="dt">sourceVar =</span> SpCond, <span class="dt">cleanVar =</span> SpCond_corr,</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">                           <span class="dt">calVal =</span> <span class="fl">1.07</span>, <span class="dt">calStd =</span> <span class="dv">1</span>, <span class="dt">factorVar =</span> corfac)</a></code></pre></div>
<p>If two standard measurements are taken, then the function <code>dr_correctTwo()</code> is utilized. The <code>calValLow</code> and <code>calValHigh</code> arguments are what the instrument was reading for the low and high concentration standard measurements respectively and the <code>calStdLow</code> and <code>calStdHigh</code> arguments are what the instrument should have been reading for the low and high concentration standard measurements respectively.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">waterTibble &lt;-<span class="st"> </span><span class="kw">dr_correctTwo</span>(waterTibble, <span class="dt">sourceVar =</span> pH, <span class="dt">cleanVar =</span> pH_corr, <span class="dt">calValLow =</span> <span class="fl">7.01</span>,</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">                           <span class="dt">calStdLow =</span> <span class="dv">7</span>, <span class="dt">calValHigh =</span> <span class="fl">11.8</span>, <span class="dt">calStdHigh =</span> <span class="dv">10</span>, <span class="dt">factorVar =</span> corfac)</a></code></pre></div>
</div>
<div id="dropping-observations" class="section level3">
<h3>Dropping Observations</h3>
<p>After the data has been corrected, some of the data will likely need to be removed (i.e. dropped) in order to account for the equilibration of the sensors as well as time out of the water during preparation for calibration. It is important to do this step last because dropping data before using <code>dr_correctOne()</code> or <code>dr_correctTwo()</code> will result in the corrections being inconsistent. To do this, the <code>dr_drop()</code> function is used. The argument <code>.data</code> is the working data frame for the correction. The arguments <code>head</code> and <code>tail</code> are the number of observations to be dropped from the beginning and end of the data set respectively. Additionally, sometimes, an instrument may malfunction for a short period, so a date range can be specified to drop data. The arguments for this are <code>dateVar</code>, which is the name of the date variable, <code>timeVar</code>, which is the name of the time variable, <code>from</code>, which is the starting date, and <code>from</code>, which is the ending date. Additionally, there is a <code>tz</code> argument, which stands for time zone. The default for <code>tz</code> is the computer’s time zone, but if data was collected in one time zone and then the data correction is implamented in a different time zone, <code>tz</code> will need to be specified as the time zone where the data was taken. If only the <code>from</code> argument is specified, then <code>to</code> is assumed to be the end of the dataset and if only <code>to</code> is specified, <code>from</code> is assumed to be the beginning of the dataset. Lastly, if there are intermitten times where the instrument is taking inaccurate data such as when a sensor port is leaking and shorting the instrument, an expression can be used to drop all of the bad data. The argument <code>exp</code> is used in this case (e.g., <code>SpCond &gt; 9000</code>).</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="co"># drop all data from the begining and end</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2">waterTibble &lt;-<span class="st"> </span><span class="kw">dr_drop</span>(waterTibble, <span class="dt">head =</span> <span class="dv">6</span>, <span class="dt">tail =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb8-3" data-line-number="3"></a>
<a class="sourceLine" id="cb8-4" data-line-number="4"><span class="co"># drop all data over the date range</span></a>
<a class="sourceLine" id="cb8-5" data-line-number="5">waterTibble &lt;-<span class="st"> </span><span class="kw">dr_drop</span>(waterTibble, <span class="dt">dateVar =</span> Date, <span class="dt">timeVar =</span> Time, </a>
<a class="sourceLine" id="cb8-6" data-line-number="6">                       <span class="dt">from =</span> <span class="st">&quot;2018-01-03&quot;</span>, <span class="dt">to =</span> <span class="st">&quot;2018-01-06&quot;</span>)</a>
<a class="sourceLine" id="cb8-7" data-line-number="7">waterTibble &lt;-<span class="st"> </span><span class="kw">dr_drop</span>(waterTibble, <span class="dt">dateVar =</span> Date, <span class="dt">timeVar =</span> Time, <span class="dt">to =</span> <span class="st">&quot;2018-01-06&quot;</span>)</a>
<a class="sourceLine" id="cb8-8" data-line-number="8">waterTibble &lt;-<span class="st"> </span><span class="kw">dr_drop</span>(waterTibble, <span class="dt">dateVar =</span> Date, <span class="dt">timeVar =</span> Time, <span class="dt">from =</span> <span class="st">&quot;2018-01-03&quot;</span>)</a>
<a class="sourceLine" id="cb8-9" data-line-number="9"></a>
<a class="sourceLine" id="cb8-10" data-line-number="10"><span class="co">#drop all data for observations that match the expression</span></a>
<a class="sourceLine" id="cb8-11" data-line-number="11">waterTibble &lt;-<span class="st"> </span><span class="kw">dr_drop</span>(waterTibble, <span class="dt">exp =</span> SpCond <span class="op">&gt;</span><span class="st"> </span><span class="dv">9000</span>)</a>
<a class="sourceLine" id="cb8-12" data-line-number="12">waterTibble &lt;-<span class="st"> </span><span class="kw">dr_drop</span>(waterTibble, <span class="dt">exp =</span> turbidity <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>)</a>
<a class="sourceLine" id="cb8-13" data-line-number="13">waterTibble &lt;-<span class="st"> </span><span class="kw">dr_drop</span>(waterTibble, <span class="dt">exp =</span> pH <span class="op">&gt;=</span><span class="st"> </span><span class="dv">9</span>)</a></code></pre></div>
</div>
<div id="replacing-incorrect-data-with-na" class="section level3">
<h3>Replacing incorrect data with NA</h3>
<p>Sometimes, individual sensors go bad or give inaccurate data, rather than the entire instrument. The function <code>dr_drop</code> cannot be used in these instances because all of the data will be dropped instead of just the data from the bad sensor. The function <code>dr_replace</code> can be used in these instances and will replace the selected data with NA, which <code>R</code> reads as blank or missing. The argument <code>.data</code> is the working dataframe. The argument <code>sourceVar</code> is the variable you want to remove data from. The argument <code>cleanVar</code> is an optional argument that must only be specified if <code>overwrite = FALSE</code>. <code>cleanVar</code> is the name of a new variable that will be generated with the removed data so that there is a copy of the original data still stored within the dataframe. The argument <code>overwrite</code> is a logical statement that if <code>TRUE</code> will remove the data from the specified variable and store that within the same variable name. However, if <code>FALSE</code>, a new variable will be created with the specified data missing. There are two methods to replace data, by a date range and by an expression. Like <code>dr_drop</code>, the arguments for the date range are <code>dateVar</code>, <code>timeVar</code>, <code>from</code>, <code>to</code>, and <code>tz</code>. The argument for the expression is <code>exp</code>.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="co"># replace only the data from one variable over a date range</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2">waterTibble &lt;-<span class="st"> </span><span class="kw">dr_replace</span>(waterTibble, <span class="dt">sourceVar =</span> pH, <span class="dt">overwrite =</span> <span class="ot">TRUE</span>, </a>
<a class="sourceLine" id="cb9-3" data-line-number="3">                          <span class="dt">dateVar =</span> Date, <span class="dt">timeVar =</span> Time, <span class="dt">from =</span> <span class="st">&quot;2018-01-03&quot;</span>, <span class="dt">to =</span> <span class="st">&quot;2018-01-06&quot;</span>)</a>
<a class="sourceLine" id="cb9-4" data-line-number="4">waterTibble &lt;-<span class="st"> </span><span class="kw">dr_replace</span>(waterTibble, <span class="dt">sourceVar =</span> pH, <span class="dt">cleanVar =</span> pH_NA, <span class="dt">overwrite =</span> <span class="ot">FALSE</span>, </a>
<a class="sourceLine" id="cb9-5" data-line-number="5">                          <span class="dt">dateVar =</span> Date, <span class="dt">timeVar =</span> Time, <span class="dt">from =</span> <span class="st">&quot;2018-01-03&quot;</span>, <span class="dt">to =</span> <span class="st">&quot;2018-01-06&quot;</span>)</a>
<a class="sourceLine" id="cb9-6" data-line-number="6"></a>
<a class="sourceLine" id="cb9-7" data-line-number="7"><span class="co"># replace only the data from one variable using an expression</span></a>
<a class="sourceLine" id="cb9-8" data-line-number="8">waterTibble &lt;-<span class="st"> </span><span class="kw">dr_replace</span>(waterTibble, <span class="dt">sourceVar =</span> pH, <span class="dt">overwrite =</span> <span class="ot">TRUE</span>, <span class="dt">exp =</span> pH <span class="op">&gt;=</span><span class="st"> </span><span class="dv">9</span>)</a>
<a class="sourceLine" id="cb9-9" data-line-number="9">waterTibble &lt;-<span class="st"> </span><span class="kw">dr_replace</span>(waterTibble, <span class="dt">sourceVar =</span> turbidity, <span class="dt">cleanVar =</span> turbidity_NA,</a>
<a class="sourceLine" id="cb9-10" data-line-number="10">                          <span class="dt">overwrite =</span> <span class="ot">FALSE</span>, <span class="dt">exp =</span> turbidity <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>)</a></code></pre></div>
</div>
</div>
<div id="tidying-data" class="section level2">
<h2>Tidying Data</h2>
<div id="renaming-variables" class="section level3">
<h3>Renaming Variables</h3>
<p>Outputs sometimes contains special characters in variable names. For example, “Turbidity+” is a variable name created by the YSI Multiparameter V2 Sonde, which is imported into <code>R</code> as <code>Turbidity.</code>. Neither the original name or <code>R</code>’s attempt at clarifying it follow good variable naming practices. You can rename <code>Turbidity.</code> using the <a href="http://dplyr.tidyverse.org/reference/select.html"><code>rename()</code></a> function from <a href="http://dplyr.tidyverse.org"><code>dplyr</code></a> to accomplish this:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">waterTibble &lt;-<span class="st"> </span><span class="kw">rename</span>(<span class="dt">Turbidity =</span> <span class="st">`</span><span class="dt">Turbidity.</span><span class="st">`</span>)</a></code></pre></div>
<p>Note how the back tick symbols are used to surround non-standard variable names.</p>
</div>
<div id="reordering-variables" class="section level3">
<h3>Reordering Variables</h3>
<p>Variables will need to be re-ordered after using <code>driftR</code> to get similar variables next to each other in your data frame. You can use the <a href="http://dplyr.tidyverse.org/reference/select.html"><code>select()</code></a> function from <a href="http://dplyr.tidyverse.org"><code>dplyr</code></a> to accomplish this:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">waterTibble &lt;-<span class="st"> </span><span class="kw">select</span>(waterTibble, Date, Time, dateTime, SpCond, SpCond_Corr, pH, pH_Corr, pHmV,</a>
<a class="sourceLine" id="cb11-2" data-line-number="2">             Chloride, Chloride_Corr, AmmoniumN, AmmoniumN_Corr, NitrateN, NitrateN_Corr,</a>
<a class="sourceLine" id="cb11-3" data-line-number="3">             Turbidity, Turbidity_Corr, DO, DO_Corr, corfac)</a></code></pre></div>
<p>Like all other <code>dplyr</code> functions, <code>select()</code> can be also included in a pipe.</p>
</div>
<div id="removing-unnecessary-variables" class="section level3">
<h3>Removing Unnecessary Variables</h3>
<p>If there are unnecessary variables left in your data set at the end of the post-processing stage, you can also use the <a href="http://dplyr.tidyverse.org/reference/select.html"><code>select()</code></a> function from <a href="http://dplyr.tidyverse.org"><code>dplyr</code></a> to remove them. The function accepts the data frame name followed by a comma and negative sign in front of the variable to be removed. For example, the <code>NitrateN</code> variable does not contain any non-zero observations in our example, so it can be removed.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">waterTibble &lt;-<span class="st"> </span><span class="kw">select</span>(waterTibble, <span class="op">-</span>NitrateN)</a></code></pre></div>
<p>If there are multiple variables to be removed, a list of the variables can be provided inside <code>-c(varlist)</code>:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">waterTibble &lt;-<span class="st"> </span><span class="kw">select</span>(waterTibble, <span class="op">-</span><span class="kw">c</span>(NitrateN, pHmV))</a></code></pre></div>
</div>
</div>
<div id="exporting-data" class="section level2">
<h2>Exporting Data</h2>
<p>Finally, data can be exported to <code>csv</code> (our recommended file format because it is plain-text and non-proprietary) using the <a href="http://readr.tidyverse.org"><code>readr</code> package’s</a> <a href="http://readr.tidyverse.org/reference/write_delim.html"><code>write_csv()</code></a> function:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="kw">write_csv</span>(df, <span class="dt">path =</span> <span class="st">&quot;waterData.csv&quot;</span>, <span class="dt">na =</span> <span class="st">&quot;NA&quot;</span>)</a></code></pre></div>
</div>
<div id="a-full-session" class="section level2">
<h2>A Full Session</h2>
<p>Below is an example of a full data set correction:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="co"># load needed packages</span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2"><span class="kw">library</span>(driftR)</a>
<a class="sourceLine" id="cb15-3" data-line-number="3"><span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb15-4" data-line-number="4"><span class="kw">library</span>(readr)</a>
<a class="sourceLine" id="cb15-5" data-line-number="5"></a>
<a class="sourceLine" id="cb15-6" data-line-number="6"><span class="co"># import data exported from a Sonde</span></a>
<a class="sourceLine" id="cb15-7" data-line-number="7"><span class="co"># example file located in the package</span></a>
<a class="sourceLine" id="cb15-8" data-line-number="8">waterTibble &lt;-<span class="st"> </span><span class="kw">dr_read</span>(<span class="dt">file =</span> <span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;rawData.csv&quot;</span>, <span class="dt">package=</span><span class="st">&quot;driftR&quot;</span>),</a>
<a class="sourceLine" id="cb15-9" data-line-number="9">                            <span class="dt">instrument =</span> <span class="st">&quot;Sonde&quot;</span>, <span class="dt">define =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb15-10" data-line-number="10"></a>
<a class="sourceLine" id="cb15-11" data-line-number="11"><span class="co"># calculate correction factors</span></a>
<a class="sourceLine" id="cb15-12" data-line-number="12"><span class="co"># results stored in new vector corrFac</span></a>
<a class="sourceLine" id="cb15-13" data-line-number="13">waterTibble &lt;-<span class="st"> </span><span class="kw">dr_factor</span>(waterTibble, <span class="dt">corrFactor =</span> corrFac, <span class="dt">dateVar =</span> Date,</a>
<a class="sourceLine" id="cb15-14" data-line-number="14">                         <span class="dt">timeVar =</span> Time, <span class="dt">keepDateTime =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb15-15" data-line-number="15"></a>
<a class="sourceLine" id="cb15-16" data-line-number="16"><span class="co"># apply one-point calibration to SpCond;</span></a>
<a class="sourceLine" id="cb15-17" data-line-number="17"><span class="co"># results stored in new vector SpConde_Corr</span></a>
<a class="sourceLine" id="cb15-18" data-line-number="18">waterTibble &lt;-<span class="st"> </span><span class="kw">dr_correctOne</span>(waterTibble, <span class="dt">sourceVar =</span> SpCond, <span class="dt">cleanVar =</span> SpCond_Corr,</a>
<a class="sourceLine" id="cb15-19" data-line-number="19">                             <span class="dt">calVal =</span> <span class="fl">1.07</span>, <span class="dt">calStd =</span> <span class="dv">1</span>, <span class="dt">factorVar =</span> corrFac)</a>
<a class="sourceLine" id="cb15-20" data-line-number="20"></a>
<a class="sourceLine" id="cb15-21" data-line-number="21"><span class="co"># apply one-point calibration to Turbidity.;</span></a>
<a class="sourceLine" id="cb15-22" data-line-number="22"><span class="co"># results stored in new vector Turbidity_Corr</span></a>
<a class="sourceLine" id="cb15-23" data-line-number="23">waterTibble &lt;-<span class="st"> </span><span class="kw">rename</span>(waterTibble, <span class="dt">Turbidity =</span> <span class="st">`</span><span class="dt">Turbidity.</span><span class="st">`</span>)</a>
<a class="sourceLine" id="cb15-24" data-line-number="24">waterTibble &lt;-<span class="st"> </span><span class="kw">dr_correctOne</span>(waterTibble, <span class="dt">sourceVar =</span> Turbidity, <span class="dt">cleanVar =</span> Turbidity_Corr,</a>
<a class="sourceLine" id="cb15-25" data-line-number="25">                    <span class="dt">calVal =</span> <span class="fl">1.3</span>, <span class="dt">calStd =</span> <span class="dv">0</span>, <span class="dt">factorVar =</span> corrFac)</a>
<a class="sourceLine" id="cb15-26" data-line-number="26"></a>
<a class="sourceLine" id="cb15-27" data-line-number="27"><span class="co"># apply one-point calibration to DO;</span></a>
<a class="sourceLine" id="cb15-28" data-line-number="28"><span class="co"># results stored in new vector DO_Corr</span></a>
<a class="sourceLine" id="cb15-29" data-line-number="29">waterTibble &lt;-<span class="st"> </span><span class="kw">dr_correctOne</span>(waterTibble, <span class="dt">sourceVar =</span> DO, <span class="dt">cleanVar =</span> DO_Corr,</a>
<a class="sourceLine" id="cb15-30" data-line-number="30">                             <span class="dt">calVal =</span> <span class="fl">97.6</span>, <span class="dt">calStd =</span> <span class="dv">99</span>, <span class="dt">factorVar =</span> corrFac)</a>
<a class="sourceLine" id="cb15-31" data-line-number="31"></a>
<a class="sourceLine" id="cb15-32" data-line-number="32"><span class="co"># apply two-point calibration to pH;</span></a>
<a class="sourceLine" id="cb15-33" data-line-number="33"><span class="co"># results stored in new vector ph_Corr</span></a>
<a class="sourceLine" id="cb15-34" data-line-number="34">waterTibble &lt;-<span class="st"> </span><span class="kw">dr_correctTwo</span>(waterTibble, <span class="dt">sourceVar =</span> pH, <span class="dt">cleanVar =</span> pH_Corr,</a>
<a class="sourceLine" id="cb15-35" data-line-number="35">                             <span class="dt">calValLow =</span> <span class="fl">7.01</span>, <span class="dt">calStdLow =</span> <span class="dv">7</span>, <span class="dt">calValHigh =</span> <span class="fl">11.8</span>,</a>
<a class="sourceLine" id="cb15-36" data-line-number="36">                             <span class="dt">calStdHigh =</span>  <span class="dv">10</span>, <span class="dt">factorVar =</span> corrFac)</a>
<a class="sourceLine" id="cb15-37" data-line-number="37"></a>
<a class="sourceLine" id="cb15-38" data-line-number="38"><span class="co"># apply two-point calibration to Chloride;</span></a>
<a class="sourceLine" id="cb15-39" data-line-number="39"><span class="co"># results stored in new vector Chloride_Corr</span></a>
<a class="sourceLine" id="cb15-40" data-line-number="40">waterTibble &lt;-<span class="st"> </span><span class="kw">dr_correctTwo</span>(waterTibble, <span class="dt">sourceVar =</span> Chloride, <span class="dt">cleanVar =</span> Chloride_Corr,</a>
<a class="sourceLine" id="cb15-41" data-line-number="41">                             <span class="dt">calValLow =</span> <span class="fl">11.6</span>, <span class="dt">calStdLow =</span> <span class="dv">10</span>, <span class="dt">calValHigh =</span> <span class="dv">1411</span>,</a>
<a class="sourceLine" id="cb15-42" data-line-number="42">                             <span class="dt">calStdHigh =</span>  <span class="dv">1000</span>, <span class="dt">factorVar =</span> corrFac)</a>
<a class="sourceLine" id="cb15-43" data-line-number="43"></a>
<a class="sourceLine" id="cb15-44" data-line-number="44"><span class="co"># drop observations to account for instrument equilibration</span></a>
<a class="sourceLine" id="cb15-45" data-line-number="45">waterTibble &lt;-<span class="st"> </span><span class="kw">dr_drop</span>(waterTibble, <span class="dt">head=</span><span class="dv">6</span>, <span class="dt">tail=</span><span class="dv">6</span>)</a>
<a class="sourceLine" id="cb15-46" data-line-number="46"></a>
<a class="sourceLine" id="cb15-47" data-line-number="47"><span class="co"># replace the pH data in the specified date range with NA</span></a>
<a class="sourceLine" id="cb15-48" data-line-number="48">waterTibble &lt;-<span class="st"> </span><span class="kw">dr_replace</span>(waterTibble, <span class="dt">sourceVar =</span> pH, <span class="dt">overwite =</span> <span class="ot">TRUE</span>, <span class="dt">dateVar =</span> Date,</a>
<a class="sourceLine" id="cb15-49" data-line-number="49">                          <span class="dt">timeVar =</span> Time, <span class="dt">from =</span> <span class="st">&quot;2018-02-05&quot;</span>, <span class="dt">to =</span> <span class="st">&quot;2018-02-09&quot;</span>)</a>
<a class="sourceLine" id="cb15-50" data-line-number="50"></a>
<a class="sourceLine" id="cb15-51" data-line-number="51"><span class="co"># reorder variables</span></a>
<a class="sourceLine" id="cb15-52" data-line-number="52">waterTibble &lt;-<span class="st"> </span><span class="kw">select</span>(waterTibble, Date, Time, dateTime, SpCond, SpCond_Corr, pH, pH_Corr, pHmV,</a>
<a class="sourceLine" id="cb15-53" data-line-number="53">                      Chloride, Chloride_Corr, AmmoniumN, NitrateN, Turbidity, Turbidity_Corr,</a>
<a class="sourceLine" id="cb15-54" data-line-number="54">                      DO, DO_Corr, corrFac)</a>
<a class="sourceLine" id="cb15-55" data-line-number="55"></a>
<a class="sourceLine" id="cb15-56" data-line-number="56"><span class="co"># export cleaned data</span></a>
<a class="sourceLine" id="cb15-57" data-line-number="57"><span class="kw">write_csv</span>(waterTibble, <span class="dt">path =</span> <span class="st">&quot;waterData.csv&quot;</span>, <span class="dt">na =</span> <span class="st">&quot;NA&quot;</span>)</a></code></pre></div>
<p>Our vignette on <a href="TidyEval.html">tidy evaluation in <code>driftR</code></a> includes an example session using <code>magrittr</code> pipe operators (<code>%&gt;%</code>).</p>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
